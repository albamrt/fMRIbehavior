---
title: ''
output: html_document
---

```{r include = FALSE}
opts_knit$set(root.dir=normalizePath('../'))
knitr::opts_chunk$set(echo = FALSE, fig.align='center', fig.pos = 'H', message = FALSE, warning = FALSE)
options(knitr.kable.NA = '')
```

```{r}
load("data/preproc_data.RData")
source('helpers/helpers.R')
source('helpers/settings.R')
```

### Repulsion from axes
```{r, fig.align='center', fig.cap = 'Repulsion from axes by group and session.', fig.height = 3}
data %>%
  ggplot(aes(x = S_rad, y = error, color = group, group = group, fill = group)) +
  geom_smooth(alpha = 0.2) +
  scale_color_manual(values=colors) +
  scale_fill_manual(values=colors) +
  facet_grid(~session) +
  labs(x = 'Stimulus postion (rad)', y = "Error",
       group = label(data$group))

binned <- data %>%
  mutate(bin = ntile(x = S_rad, n = 10)) %>%
  group_by(bin, subject, group, time) %>%
  summarise(mean_error = mean(error)) %>%
  group_by(subject, group, time) %>%
  summarise(sd_error = sd(mean_error)) %>%
  as.data.frame()
```

### Modelling repulsion from axes
```{r}
anova(lm(sd_error ~ group*time, data = binned)) %>%
  kable(booktabs = TRUE, escape = FALSE, digits = digits,
        caption = "Linear model where the response is the standard deviation of the mean error computed for each of 10 bins of the stimulus position by subject and timepoint.") %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F) 
```

```{r results = FALSE}
require(McSpatial)
require(sjlabelled)
require(labelled)

fit <- data %>%
  group_by(subject, time) %>%
  nest() %>%
  # mutate(Fourier = map(.x = data, .f = ~fourier(.x$error ~ .x$R_rad, q = 1, crit = "gcv"))) %>%
  mutate(data = map(.x = data, 
                    ~ mutate(.x, 
                             fourier_yhat = unlabelled(fourier(error ~ R_rad, q = 1)$yhat)))) %>%
  unnest(data) %>%
  mutate(fourier_error = fourier_yhat - error)
```
